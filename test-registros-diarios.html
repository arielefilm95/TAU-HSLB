<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Registros Diarios</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Registros Diarios</h1>
    <p>Esta p√°gina permite verificar que los cambios para registros diarios funcionen correctamente.</p>

    <div class="test-section">
        <h2>üìä Verificar Conexi√≥n con Supabase</h2>
        <button class="test-button" onclick="testSupabaseConnection()">Probar Conexi√≥n</button>
        <div id="connectionResult"></div>
    </div>

    <div class="test-section">
        <h2>üóÉÔ∏è Verificar Campo origen_registro</h2>
        <button class="test-button" onclick="testOrigenRegistro()">Verificar Campo</button>
        <div id="origenResult"></div>
    </div>

    <div class="test-section">
        <h2>üìÖ Probar Filtro de Fecha</h2>
        <button class="test-button" onclick="testFiltroFecha()">Probar Filtro D√≠a Actual</button>
        <div id="fechaResult"></div>
    </div>

    <div class="test-section">
        <h2>üßπ Probar Limpieza Autom√°tica</h2>
        <button class="test-button" onclick="testLimpiezaAutomatica()">Probar Limpieza</button>
        <div id="limpiezaResult"></div>
    </div>

    <div class="test-section">
        <h2>üìã Crear Registro de Prueba</h2>
        <button class="test-button" onclick="crearRegistroManual()">Crear Registro Manual</button>
        <button class="test-button" onclick="verificarRegistrosRecientes()">Verificar Registros Recientes</button>
        <div id="registroResult"></div>
    </div>

    <div class="test-section">
        <h2>üìù Log de Pruebas</h2>
        <div id="testLog" class="log"></div>
        <button class="test-button" onclick="limpiarLog()">Limpiar Log</button>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://oywepfjbzvnzvcnqtlnv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95d2VwZmpienZuenZjbnF0bG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTg0NzgsImV4cCI6MjA3NzkzNDQ3OH0.nnJ3tbgoWdu1-qcnpZwDK6W_WQSDmVFU_Hf-5XCpDo4';
        
        let supabase;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function limpiarLog() {
            document.getElementById('testLog').textContent = '';
        }

        async function testSupabaseConnection() {
            try {
                log('üîÑ Probando conexi√≥n con Supabase...');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await supabase
                    .from('madres')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                showResult('connectionResult', '‚úÖ Conexi√≥n con Supabase establecida correctamente', 'success');
                log('‚úÖ Conexi√≥n exitosa con Supabase');
                
            } catch (error) {
                showResult('connectionResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                log(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        async function testOrigenRegistro() {
            try {
                log('üîÑ Verificando campo origen_registro...');
                
                const { data, error } = await supabase
                    .from('madres')
                    .select('origen_registro')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('column') && error.message.includes('origen_registro')) {
                        showResult('origenResult', '‚ùå El campo origen_registro no existe. Ejecuta el script agregar-campo-origen-madres.sql', 'error');
                        log('‚ùå Campo origen_registro no encontrado');
                    } else {
                        throw error;
                    }
                } else {
                    showResult('origenResult', '‚úÖ Campo origen_registro encontrado y funcionando', 'success');
                    log('‚úÖ Campo origen_registro verificado correctamente');
                }
                
            } catch (error) {
                showResult('origenResult', `‚ùå Error verificando campo: ${error.message}`, 'error');
                log(`‚ùå Error al verificar origen_registro: ${error.message}`);
            }
        }

        async function testFiltroFecha() {
            try {
                log('üîÑ Probando filtro por fecha actual...');
                
                // Obtener fecha actual
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                
                const startOfDayISO = startOfDay.toISOString();
                const endOfDayISO = endOfDay.toISOString();
                
                log(`üìÖ Buscando registros entre ${startOfDayISO} y ${endOfDayISO}`);
                
                // Probar consulta con filtro de fecha y origen
                const { data, error } = await supabase
                    .from('madres')
                    .select('*')
                    .eq('origen_registro', 'MANUAL')
                    .gte('created_at', startOfDayISO)
                    .lt('created_at', endOfDayISO);
                
                if (error) {
                    throw error;
                }
                
                const count = data ? data.length : 0;
                showResult('fechaResult', `‚úÖ Filtro de fecha funcionando. Se encontraron ${count} registros manuales del d√≠a`, 'success');
                log(`‚úÖ Filtro de fecha exitoso: ${count} registros manuales encontrados`);
                
            } catch (error) {
                showResult('fechaResult', `‚ùå Error en filtro de fecha: ${error.message}`, 'error');
                log(`‚ùå Error al probar filtro de fecha: ${error.message}`);
            }
        }

        function testLimpiezaAutomatica() {
            try {
                log('üîÑ Probando limpieza autom√°tica...');
                
                // Simular la funci√≥n de limpieza
                if (typeof window.clearRecentMothersDisplay === 'function') {
                    window.clearRecentMothersDisplay();
                    showResult('limpiezaResult', '‚úÖ Funci√≥n de limpieza autom√°tica disponible', 'success');
                    log('‚úÖ Funci√≥n clearRecentMothersDisplay ejecutada correctamente');
                } else {
                    showResult('limpiezaResult', '‚ö†Ô∏è Funci√≥n de limpieza no disponible (esto es normal en esta p√°gina de prueba)', 'info');
                    log('‚ö†Ô∏è Funci√≥n de limpieza no disponible en esta p√°gina de prueba');
                }
                
            } catch (error) {
                showResult('limpiezaResult', `‚ùå Error en limpieza: ${error.message}`, 'error');
                log(`‚ùå Error al probar limpieza: ${error.message}`);
            }
        }

        async function crearRegistroManual() {
            try {
                log('üîÑ Creando registro manual de prueba...');
                
                const testMadre = {
                    nombre: 'MADRE',
                    apellido: 'PRUEBA',
                    rut: '12345678-9',
                    numero_ficha: 'TEST-' + Date.now(),
                    sala: 'TEST',
                    cama: '01',
                    cantidad_hijos: 1,
                    origen_registro: 'MANUAL'
                };
                
                const { data, error } = await supabase
                    .from('madres')
                    .insert([testMadre])
                    .select()
                    .single();
                
                if (error) {
                    throw error;
                }
                
                showResult('registroResult', `‚úÖ Registro manual creado con ID: ${data.id}`, 'success');
                log(`‚úÖ Registro manual creado: ${data.id} - ${testMadre.nombre} ${testMadre.apellido}`);
                
            } catch (error) {
                showResult('registroResult', `‚ùå Error creando registro: ${error.message}`, 'error');
                log(`‚ùå Error al crear registro manual: ${error.message}`);
            }
        }

        async function verificarRegistrosRecientes() {
            try {
                log('üîÑ Verificando registros recientes del d√≠a...');
                
                // Obtener fecha actual
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                
                const startOfDayISO = startOfDay.toISOString();
                const endOfDayISO = endOfDay.toISOString();
                
                // Obtener registros manuales del d√≠a
                const { data: manuales, error: errorManuales } = await supabase
                    .from('madres')
                    .select('*')
                    .eq('origen_registro', 'MANUAL')
                    .gte('created_at', startOfDayISO)
                    .lt('created_at', endOfDayISO);
                
                // Obtener registros importados del d√≠a
                const { data: importados, error: errorImportados } = await supabase
                    .from('madres')
                    .select('*')
                    .eq('origen_registro', 'IMPORTADO')
                    .gte('created_at', startOfDayISO)
                    .lt('created_at', endOfDayISO);
                
                if (errorManuales || errorImportados) {
                    throw errorManuales || errorImportados;
                }
                
                const countManuales = manuales ? manuales.length : 0;
                const countImportados = importados ? importados.length : 0;
                
                const message = `‚úÖ Verificaci√≥n completada:<br>
                    üìù Registros manuales del d√≠a: ${countManuales}<br>
                    üìä Registros importados del d√≠a: ${countImportados}<br>
                    üéØ En "Registros Recientes" deber√≠an aparecer solo los ${countManuales} manuales`;
                
                showResult('registroResult', message, 'success');
                log(`‚úÖ Verificaci√≥n completada: ${countManuales} manuales, ${countImportados} importados`);
                
            } catch (error) {
                showResult('registroResult', `‚ùå Error verificando registros: ${error.message}`, 'error');
                log(`‚ùå Error al verificar registros recientes: ${error.message}`);
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina de prueba cargada');
            log('üìã Ejecuta las pruebas en orden para verificar el funcionamiento');
        });
    </script>
</body>
</html>